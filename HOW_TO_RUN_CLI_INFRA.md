# Как Запустить Проверки Инфраструктуры с CLI Скриптами

## Почему Использовать CLI Скрипты?
Из-за ограничений IAM для пользователя тестового задания, невозможно запустить полные Terraform apply/destroy воркфлоу (например, из-за отсутствия разрешений для ec2:DescribeAvailabilityZones и prevent_destroy). Для демонстрации создания и удаления инфраструктуры мы предоставляем bash скрипты, которые используют AWS CLI для создания и удаления всех основных ресурсов.

## Предварительные Требования
- AWS CLI установлен и настроен (или экспортируйте AWS credentials как переменные окружения)
- Достаточные разрешения для создания и удаления VPC, Subnet, IGW, Route Table, Security Group в целевом AWS аккаунте
- Bash shell

## Пошаговые Инструкции

### 1. Экспорт AWS Credentials
Экспортируйте ваши AWS credentials и регион (замените на ваши реальные ключи):
```bash
export AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY
export AWS_DEFAULT_REGION=us-east-2
```

### 2. Деплой Инфраструктуры
Запустите скрипт деплоя для создания всех основных ресурсов:
```bash
bash scripts/deploy-infra-cli.sh
```
Вы увидите вывод для каждого шага: VPC, subnets, IGW, route table, security group и их ID.

### 3. Удаление Инфраструктуры
После тестирования запустите скрипт удаления для очистки всех ресурсов:
```bash
bash scripts/teardown-infra-cli.sh
```
Скрипт удалит все ресурсы в правильном порядке, автоматически обрабатывая зависимости.

## Последовательность Создания/Удаления Ресурсов
1. **VPC** создается первым.
2. **Subnets** (A и B) создаются в разных AZ внутри VPC.
3. **Internet Gateway (IGW)** создается и прикрепляется к VPC.
4. **Route Table** создается и связывается с subnets; добавляется маршрут по умолчанию к IGW.
5. **Security Group** создается и настраивается для SSH, HTTP и HTTPS доступа.
6. **Teardown** скрипт удаляет ресурсы в обратном порядке, обеспечивая обработку всех зависимостей (subnets, route table associations, IGW, VPC, и т.д.).

## Примечания
- Эти скрипты только для демонстрации и валидации в тестовой среде.
- В продакшене используйте Terraform для полного infrastructure as code, динамического выбора AZ и управления состоянием.
- CLI скрипты идемпотентны и безопасны для многократного запуска, но всегда проверяйте AWS Console на наличие "осиротевших" ресурсов после тестирования.

## Почему Не Использовать Terraform Напрямую?
Из-за явных deny политик на тестовом пользователе, некоторые операции Terraform (как динамическое обнаружение AZ и защита ресурсов) невозможны. CLI скрипты предоставляют способ демонстрации и валидации логики создания инфраструктуры при этих ограничениях. 

## Шаги Статического Анализа Кода

Для обеспечения качества и безопасности кода были выполнены следующие шаги статического анализа:

### Terraform
- **Проверка Форматирования:**
  ```bash
  terraform fmt -check
  ```
  Проверяет, что все Terraform файлы правильно отформатированы.

- **Валидация:**
  ```bash
  terraform validate
  ```
  Валидирует синтаксис и структуру Terraform конфигурационных файлов.

- **Рекомендуемые (опционально):**
  - **tflint** — Линт Terraform кода для лучших практик и ошибок.
  - **tfsec** — Сканирование Terraform кода на проблемы безопасности.
  - **checkov** — Дополнительное сканирование безопасности для IaC.

### Shell Скрипты
- **ShellCheck:**
  ```bash
  shellcheck scripts/deploy-infra-cli.sh
  shellcheck scripts/teardown-infra-cli.sh
  ```
  Проверяет shell скрипты на ошибки, проблемы безопасности и лучшие практики.

- **Рекомендуемые (опционально):**
  - **shfmt** — Авто-форматирование shell скриптов.
  - **bashate** — Линт bash скриптов на стиль и ошибки.

### Kubernetes Манифесты
- **Валидация (уже в пайплайне):**
  ```bash
  kubectl apply --dry-run=client -f k8s-manifests/backend/
  kubectl apply --dry-run=client -f k8s-manifests/gateway/
  ```
  Валидирует Kubernetes манифесты на синтаксис и структуру.

- **Рекомендуемые (опционально):**
  - **kubeval** — Валидировать Kubernetes YAML файлы против Kubernetes схемы.
  - **kube-score** или **kubesec** — Анализировать Kubernetes манифесты на безопасность и лучшие практики.
  - **yamllint** — Линт YAML файлов на синтаксис и стиль.

Эти проверки помогают обеспечить, что кодовая база поддерживаема, безопасна и готова к продакшен деплою. 